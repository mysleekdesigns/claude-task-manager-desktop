// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}


model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  passwordHash  String
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  projectMembers ProjectMember[]
  sessions       Session[]
  assignedTasks  Task[]      @relation("assignee")
  githubTokens   GitHubToken[]
  ideas          Idea[]      @relation("CreatedIdeas")
  settings       UserSettings?
}

model UserSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  claudeApiKey         String?
  githubToken          String?
  defaultTerminalCount Int      @default(2)
  theme                String   @default("system")
  keyboardShortcuts    String?  // JSON string
  autoLaunchClaude     Boolean  @default(true)
  minimizeToTray       Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  targetPath  String?
  githubRepo  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members    ProjectMember[]
  tasks      Task[]
  terminals  Terminal[]
  worktrees  Worktree[]
  phases     Phase[]
  features         Feature[]
  memories         Memory[]
  mcpConfigs       McpConfig[]
  ideas            Idea[]
  changelogEntries ChangelogEntry[]

  @@index([createdAt])
}

model ProjectMember {
  id        String   @id @default(cuid())
  role      String   @default("MEMBER") // ProjectRole: OWNER, ADMIN, MEMBER, VIEWER
  userId    String
  projectId String
  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([projectId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Task {
  id                 String             @id @default(cuid())
  title              String
  description        String?
  branchName         String?
  status             String             @default("PLANNING") // TaskStatus: PENDING, PLANNING, IN_PROGRESS, AI_REVIEW, HUMAN_REVIEW, COMPLETED, CANCELLED
  priority           String             @default("MEDIUM") // Priority: LOW, MEDIUM, HIGH, URGENT
  tags               String             @default("[]") // JSON array as string
  projectId          String
  assigneeId         String?
  parentId           String?
  claudeSessionId    String?            // UUID for Claude Code session
  claudeSessionName  String?            // Human-readable session name
  claudeTerminalId   String?            // Terminal ID for Claude Code process
  claudeStartedAt    DateTime?          // When Claude started working
  claudeCompletedAt  DateTime?          // When Claude finished
  claudeStatus       ClaudeTaskStatus   @default(IDLE)
  prdPhaseNumber     Int?               // The phase number from the PRD this task is scoped to (null if not phase-scoped)
  prdPhaseName       String?            // The phase name (e.g., "Project Foundation")
  scopedPrdContent   String?            // The extracted phase content that will be sent to Claude (only this phase's requirements)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relations
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee       User?           @relation("assignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  parent         Task?           @relation("subtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks       Task[]          @relation("subtasks")
  phases         TaskPhase[]
  logs           TaskLog[]
  files          TaskFile[]
  terminals      Terminal[]
  changelogEntry ChangelogEntry?
  activities     TaskActivity[]
  reviews        TaskReview[]
  fixes          TaskFix[]
  taskSummary    TaskSummary?

  @@index([projectId])
  @@index([status])
  @@index([priority])
  @@index([assigneeId])
  @@index([parentId])
  @@index([claudeStatus])
  @@index([createdAt])
}

model TaskPhase {
  id        String   @id @default(cuid())
  name      String
  status    String   @default("PENDING") // PhaseStatus: PENDING, IN_PROGRESS, COMPLETED, FAILED
  model     String?  // Model name or type (e.g., "claude-3-5-sonnet")
  taskId    String
  startedAt DateTime?
  endedAt   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task      Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  logs      TaskLog[]

  @@index([taskId])
  @@index([status])
  @@index([createdAt])
}

model TaskLog {
  id        String   @id @default(cuid())
  type      String   // e.g., "info", "warning", "error", "success"
  message   String
  metadata  String   @default("{}") // JSON object as string
  taskId    String
  phaseId   String?
  createdAt DateTime @default(now())

  // Relations
  task      Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  phase     TaskPhase? @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([phaseId])
  @@index([type])
  @@index([createdAt])
}

model TaskFile {
  id        String   @id @default(cuid())
  path      String   // File path relative to project
  action    String   // e.g., "created", "modified", "deleted"
  taskId    String
  createdAt DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([createdAt])
}

model Worktree {
  id        String     @id @default(cuid())
  name      String
  path      String
  branch    String
  isMain    Boolean    @default(false)
  projectId String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  terminals Terminal[]

  @@index([projectId])
  @@index([branch])
  @@index([createdAt])
}

model Terminal {
  id         String   @id @default(cuid())
  name       String
  status     String   @default("idle") // idle, running, suspended, crashed
  pid        Int?
  projectId  String
  worktreeId String?
  taskId     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  worktree   Worktree? @relation(fields: [worktreeId], references: [id], onDelete: SetNull)
  task       Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([worktreeId])
  @@index([taskId])
  @@index([status])
  @@index([createdAt])
}

enum MoscowPriority {
  MUST
  SHOULD
  COULD
  WONT
}

enum ClaudeTaskStatus {
  IDLE
  STARTING
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  AWAITING_INPUT
}

model Phase {
  id          String      @id @default(cuid())
  name        String
  description String?
  order       Int
  status      String      @default("planned") // planned, in_progress, completed
  projectId   String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  features    Feature[]
  milestones  Milestone[]

  @@index([projectId])
  @@index([status])
  @@index([order])
  @@index([createdAt])
}

model Feature {
  id          String         @id @default(cuid())
  title       String
  description String?
  priority    MoscowPriority
  status      String         @default("planned") // planned, in_progress, completed, cancelled
  projectId   String
  phaseId     String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phase       Phase?         @relation(fields: [phaseId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([phaseId])
  @@index([priority])
  @@index([status])
  @@index([createdAt])
}

model Milestone {
  id        String   @id @default(cuid())
  title     String
  completed Boolean  @default(false)
  phaseId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  phase     Phase    @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@index([phaseId])
  @@index([completed])
  @@index([createdAt])
}

model Memory {
  id        String   @id @default(cuid())
  type      String   // session, pr_review, codebase, pattern, gotcha
  title     String
  content   String
  metadata  String   @default("{}") // JSON string for SQLite
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
  @@index([createdAt])
}

model McpConfig {
  id        String   @id @default(cuid())
  name      String
  type      String
  enabled   Boolean  @default(false)
  config    String?  // JSON string
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
  @@index([createdAt])
}

enum IdeaStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  CONVERTED
}

model Idea {
  id          String     @id @default(cuid())
  title       String
  description String?
  votes       Int        @default(0)
  status      IdeaStatus @default(PENDING)
  projectId   String
  createdById String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  project     Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdBy   User       @relation("CreatedIdeas", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([createdById])
  @@index([votes])
  @@index([createdAt])
}

model GitHubToken {
  id            String   @id @default(cuid())
  userId        String
  encryptedToken String  // Encrypted token (encryption handled at service layer)
  scopes        String   @default("[]") // JSON array of scopes as string
  isValid       Boolean  @default(true) // Validation status
  lastValidatedAt DateTime?
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isValid])
  @@index([createdAt])
}

enum ChangelogEntryType {
  FEATURE
  FIX
  IMPROVEMENT
  BREAKING
}

model ChangelogEntry {
  id          String             @id @default(cuid())
  title       String
  description String?
  version     String?
  type        ChangelogEntryType @default(FEATURE)
  taskId      String?            @unique
  projectId   String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Relations
  project     Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?              @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([type])
  @@index([version])
  @@index([createdAt])
}

model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String
  type      String   // tool_use, text, thinking, error, decision
  toolName  String?  // Read, Write, Bash, etc.
  summary   String   // Human-readable description
  details   String?  // JSON with full details
  duration  Int?     // milliseconds
  createdAt DateTime @default(now())

  // Relations
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([type])
  @@index([createdAt])
}

model TaskReview {
  id          String    @id @default(cuid())
  taskId      String
  reviewType  String    // security, quality, testing, performance, documentation
  status      String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED
  score       Int?      // 0-100
  summary     String?
  findings    String    @default("[]") // JSON array
  terminalId  String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, reviewType])
  @@index([taskId])
  @@index([status])
}

model TaskFix {
  id            String    @id @default(cuid())
  taskId        String
  fixType       String    // 'security' | 'quality' | 'testing'
  status        String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED
  summary       String?
  findings      String    @default("[]") // JSON array of findings being fixed
  patch         String?   // Generated fix/patch content
  researchNotes String?   // Research findings from CrawlForge
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  task          Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, fixType])
  @@index([taskId])
  @@index([status])
}

model TaskSummary {
  id           String   @id @default(cuid())
  taskId       String   @unique
  summary      String
  keyChanges   String   @default("[]") // JSON array
  filesChanged Int      @default(0)
  linesAdded   Int      @default(0)
  linesRemoved Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}
